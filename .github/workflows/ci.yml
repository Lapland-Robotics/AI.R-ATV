name: Autonomous_Robot CI Pipeline

on:
  push:
    branches: [ "main", "dev", "ros2-humble-cyclonedds", "ros2-humble-zenoh"]
  pull_request:
    branches: [ "main", "dev", "ros2-humble-cyclonedds", "ros2-humble-zenoh"]

jobs:

  build-software-ros2:

    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Build ROS2 docker image
      run: |
        cd Software
        docker build . --tag robot-ros2-image:latest

    - name: Test ROS2 docker image
      run: |
        docker run --rm robot-ros2-image:latest echo "ROS2 image built successfully"

  build-software-microros:

    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Build microros docker image
      run: |
        cd Software
        docker build . --file microros.Dockerfile --tag robot-microros-image:latest

    - name: Test microros docker image
      run: |
        docker run --rm --entrypoint="" robot-microros-image:latest echo "MicroROS image built successfully"

  build-firmware:

    runs-on: ubuntu-22.04

    strategy:
      matrix:
        project:
          - Firmware/Robots/Snower
          - Firmware/Robots/MiniATV
          - Firmware/GNSS/zedf9p_esp32
          - Firmware/Trigger
          - Firmware/Ultrasonic

    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ runner.os }}-pio
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install PlatformIO Core
        run: |
          sudo apt-get update
          sudo apt-get install -y python3.11-venv
          wget -O get-platformio.py https://raw.githubusercontent.com/platformio/platformio-core-installer/master/get-platformio.py
          python3 get-platformio.py

      - name: Build ${{ matrix.project }}
        working-directory: ${{ matrix.project }}
        run: |
          export PATH="$HOME/.platformio/penv/bin:$PATH"
          pio run
